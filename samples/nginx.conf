
upstream matrix_workers {
        server localhost:8083;
        server localhost:8084;
        server localhost:8085;
        server localhost:8086;
    }

server {
    listen 8448 ssl;
    listen [::]:8448 ssl;

    server_name MY_SERVER_DOMAIN;
    
    location ~* ^(\/_matrix\/client\/(v2_alpha|r0)\/sync) {
         proxy_set_header Host $host;
         proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;                 
        proxy_pass         http://matrix_workers;           
         client_max_body_size 50M;
    }
 
    location ~* ^(\/_matrix\/client\/(api/v1|r0|unstable)\/rooms\/.*\/(join|invite|leave|ban|unban|kick)) {
        proxy_set_header Host $host;
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;                 
        proxy_pass         http://matrix_workers;           
        client_max_body_size 50M;
    }
 
 
   location ~* ^(\/_matrix\/client\/(api/v1|r0|unstable)\/login) {
        proxy_set_header Host $host;
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;                 
        proxy_pass         http://matrix_workers;           
        client_max_body_size 50M;
    }

    location / {
        proxy_set_header   X-Forwarded-For $remote_addr;
        proxy_set_header   Host $http_host;
        proxy_pass         http://localhost:8008;
    }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/MY_SERVER_DOMAIN/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/MY_SERVER_DOMAIN/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}
